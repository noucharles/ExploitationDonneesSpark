package fr.binome.reader;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.spark.SparkConf;
import org.apache.spark.sql.Dataset;
import org.apache.spark.sql.Encoders;
import org.apache.spark.sql.Row;
import org.apache.spark.sql.SparkSession;

import java.util.function.Supplier;

@Slf4j
@RequiredArgsConstructor
public class CsvFileReader implements Supplier<Dataset<Row>> {
    private final String inputPathStr;
    private final SparkSession sparkSession;

    public CsvFileReader(String inputPathStr) {
        this(inputPathStr, SparkSession.builder().config(new SparkConf().setMaster("local[2]").setAppName("AppSparkHospital")).getOrCreate());
    }

    @Override
    public Dataset<Row> get() {
        try {
            Dataset<Row> lines = sparkSession.read().option("delimiter", ";").option("header","true").csv(inputPathStr);
            return lines;
        } catch (Exception exception) {
            log.error("failed to read file at inputPathStr={} due to ...", inputPathStr, exception);
            return null;
        }

    }
}
